<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نقاط فريق الدوري - نسخة تجريبية</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
table { margin: auto; border-collapse: collapse; width: 90%; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background-color: #f4f4f4; }
thead th { position: sticky; top: 0; background: #f4f4f4; }
</style>
</head>
<body>
<h1>نقاط فريقكم في الدوري</h1>
<p>تحديث تلقائي كل 60 ثانية</p>
<table id="pointsTable">
<thead>
<tr>
<th>اللاعب</th>
<th>نقاط مجموع الجولات</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const teamIds = [1679569, 1794623, 6154272, 6099187, 7327, 812591, 70862, 6273627];
const updateInterval = 60000; // 60 ثانية

async function fetchPlayerPoints(teamId, eventId) {
    const teamData = await fetch(`https://fantasy.premierleague.com/api/entry/${teamId}/event/${eventId}/`).then(res => res.json());
    const picks = teamData.picks;
    let playerPoints = [];

    for (let pick of picks) {
        const playerId = pick.element;
        const playerInfo = await fetch(`https://fantasy.premierleague.com/api/element-summary/${playerId}/`).then(res => res.json());
        const history = playerInfo.history.filter(h => h.round === eventId);
        let total = 0;
        history.forEach(h => total += h.total_points);
        playerPoints.push({name: playerInfo.web_name, totalPoints: total});
    }
    return playerPoints;
}

async function loadAllPoints() {
    const tbody = document.querySelector('#pointsTable tbody');
    tbody.innerHTML = '';
    let totalTeamPoints = 0;
    let allPlayers = {};

    const bootstrap = await fetch('https://fantasy.premierleague.com/api/bootstrap-static/').then(res => res.json());
    let currentEvent = bootstrap.events.find(e => e.is_current);

    // إذا الموسم ما بدأ، نجيب آخر جولة من الموسم الماضي
    if (!currentEvent) {
        currentEvent = bootstrap.events[bootstrap.events.length - 1];
    }

    const eventId = currentEvent.id;

    for (let teamId of teamIds) {
        try {
            const players = await fetchPlayerPoints(teamId, eventId);
            players.forEach(p => {
                if(!allPlayers[p.name]) allPlayers[p.name] = 0;
                allPlayers[p.name] += p.totalPoints;
            });
        } catch(err) {
            console.error(`خطأ في Team ID ${teamId}`, err);
        }
    }

    for (let [name, points] of Object.entries(allPlayers)) {
        totalTeamPoints += points;
        const row = document.createElement('tr');
        row.innerHTML = `<td>${name}</td><td>${points}</td>`;
        tbody.appendChild(row);
    }

    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `<th>المجموع الكلي للفريق</th><th>${totalTeamPoints}</th>`;
    tbody.appendChild(totalRow);
}

loadAllPoints();
setInterval(loadAllPoints, updateInterval);
</script>
</body>
</html>
